# System JSON Structures Reference

This document defines **ALL** JSON structures used throughout the ConvoTravelInsure system. This is the **single source of truth** for JSON schemas.

---

## 📋 Table of Contents

1. [OCR Extracted Document JSON](#ocr-extracted-document-json)
2. [Conversation State Structures](#conversation-state-structures)
3. [Ancileo API Structures](#ancileo-api-structures)
4. [Database JSON Storage](#database-json-storage)
5. [Frontend-Backend API Structures](#frontend-backend-api-structures)

---

## 📄 OCR Extracted Document JSON

### Flight Confirmation Document

**Source:** OCR/LLM extraction from uploaded PDFs  
**Stored in:** `state["document_data"][-1]["extracted_json"]`  
**Used by:** `process_document` node in conversation graph

```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "document_type": "flight_confirmation",
  "extracted_at": "2025-01-15T10:30:00Z",
  "source_filename": "flight_confirmation.pdf",
  "trip_type": "return",  // "return" or "one-way"
  
  "airline": {
    "outbound": {
      "name": "Korean Air",
      "code": "KE",
      "confidence": 0.95
    },
    "inbound": {
      "name": "Singapore Airlines",
      "code": "SQ",
      "confidence": 0.95
    }
  },
  
  "flight_details": {
    "departure": {
      "date": "2025-12-28",  // YYYY-MM-DD format (REQUIRED)
      "time": "10:40",
      "airport_code": "SIN",
      "airport_name": "Singapore Changi Airport",
      "confidence": 0.95
    },
    "return": {
      "date": "2026-01-08",  // YYYY-MM-DD format (REQUIRED for round trip)
      "time": "12:35",
      "airport_code": "ICN",
      "airport_name": "Incheon International Airport",
      "confidence": 0.95
    },
    "flight_numbers": {
      "outbound": "KE648",
      "inbound": "SQ611",
      "confidence": 0.95
    }
  },
  
  "destination": {
    "country": "South Korea",  // REQUIRED - Full country name
    "city": "Seoul",
    "airport_code": "ICN",
    "confidence": 0.92
  },
  
  "travelers": [
    {
      "name": {
        "first": "Xianyan Winston",
        "last": "Yang",
        "full": "Xianyan Winston Yang",
        "confidence": 0.95
      },
      "ticket": {
        "ticket_number": "180-7311968098",
        "confidence": 0.85,
        "class": {
          "service_class": "Economy",
          "code": "Q",
          "confidence": 0.9
        },
        "cost": null
      }
    }
  ],
  
  "trip_duration": {
    "days": 11,
    "calculated_from_dates": true,
    "confidence": 0.95
  },
  
  "booking_reference": {
    "pnr": "CA7OYY",
    "booking_number": "1578942670013928",
    "confidence": 0.95
  }
}
```

### Critical Fields for Conversation Flow

When processing `flight_confirmation` documents, the system extracts:

```python
# From extracted_json:
destination = extracted_json["destination"]["country"]  # e.g., "South Korea"
departure_date = extracted_json["flight_details"]["departure"]["date"]  # e.g., "2025-12-28"
return_date = extracted_json["flight_details"]["return"]["date"]  # e.g., "2026-01-08"
travelers_count = len(extracted_json["travelers"])  # e.g., 1
```

**Note:** If `return_date` exists, trip is **RT** (round trip). If missing, trip is **ST** (single trip).

---

## 🔄 Conversation State Structures

### Trip Details (`state["trip_details"]`)

**Used in:** Conversation graph state  
**Updated by:** `needs_assessment`, `process_document` nodes

```json
{
  "destination": "South Korea",  // Full country name (REQUIRED)
  "departure_date": "2025-12-28",  // YYYY-MM-DD or date object (REQUIRED)
  "return_date": "2026-01-08",  // YYYY-MM-DD or date object (REQUIRED for RT)
  "departure_country": "SG",  // ISO 2-letter code (default: "SG")
  "arrival_country": "KR",  // ISO 2-letter code (REQUIRED for Ancileo API)
  "adults_count": 1,  // Number of adults >= 18 (REQUIRED)
  "children_count": 0,  // Number of children < 18
  "area": "area_c",  // Geographic area code from GeoMapper
  "base_rate": 8.0  // Base insurance rate per day
}
```

### Travelers Data (`state["travelers_data"]`)

```json
{
  "ages": [21],  // Array of ages (REQUIRED when available)
  "count": 1  // Total number of travelers (fallback if ages not available)
}
```

### Preferences (`state["preferences"]`)

```json
{
  "adventure_sports": false  // Boolean (REQUIRED - defaults to false if not set)
}
```

### Quote Data (`state["quote_data"]`)

**Generated by:** `pricing` node  
**Used by:** Frontend to display quotes

```json
{
  "success": true,
  "destination": "South Korea",
  "area": "area_c",
  "departure_date": "2025-12-28",
  "return_date": "2026-01-08",
  "duration_days": 11,
  "travelers_count": 1,
  "adventure_sports": false,
  "quotes": {
    "standard": {
      "tier": "standard",
      "price": 88.0,
      "currency": "SGD",
      "coverage": {
        "medical_coverage": 50000,
        "trip_cancellation": 10000,
        "baggage_loss": 3000,
        "personal_accident": 25000
      },
      "breakdown": {
        "duration_days": 11,
        "travelers_count": 1,
        "area": "area_c",
        "source": "ancileo_api"
      }
    },
    "elite": {
      "tier": "elite",
      "price": 105.6,
      "currency": "SGD",
      "coverage": {
        "medical_coverage": 100000,
        "trip_cancellation": 20000,
        "baggage_loss": 5000,
        "personal_accident": 50000,
        "adventure_sports": true
      }
    },
    "premier": {
      "tier": "premier",
      "price": 132.0,
      "currency": "SGD",
      "coverage": {
        "medical_coverage": 200000,
        "trip_cancellation": 50000,
        "baggage_loss": 10000,
        "personal_accident": 100000,
        "adventure_sports": true,
        "emergency_evacuation": 500000
      }
    }
  },
  "ancileo_reference": "f7562de0-b914-4f2c-8d5e-cb7a2519b869",
  "recommended_tier": "standard",
  "fallback": false
}
```

---

## 🌐 Ancileo API Structures

### Quotation Request

**Endpoint:** `POST /v1/travel/front/pricing`  
**Built by:** `build_ancileo_quotation_json()`

```json
{
  "market": "SG",
  "languageCode": "en",
  "channel": "white-label",
  "deviceType": "DESKTOP",
  "context": {
    "tripType": "RT",  // "RT" (round trip) or "ST" (single trip)
    "departureDate": "2025-12-28",  // YYYY-MM-DD (REQUIRED)
    "departureCountry": "SG",  // ISO 2-letter (REQUIRED)
    "arrivalCountry": "KR",  // ISO 2-letter (REQUIRED)
    "adultsCount": 1,  // >= 1 (REQUIRED)
    "childrenCount": 0,  // Optional, default: 0
    "returnDate": "2026-01-08"  // YYYY-MM-DD (REQUIRED for RT, OMIT for ST)
  }
}
```

**Critical Rules:**
- `tripType: "RT"` → **MUST** include `returnDate`
- `tripType: "ST"` → **MUST NOT** include `returnDate`
- All dates in `YYYY-MM-DD` format
- Country codes must be ISO 2-letter (uppercase)

### Purchase Request

**Endpoint:** `POST /v1/travel/front/purchase`  
**Built by:** `build_ancileo_purchase_json()`

```json
{
  "market": "SG",
  "languageCode": "en",
  "channel": "white-label",
  "quoteId": "f7562de0-b914-4f2c-8d5e-cb7a2519b869",
  "purchaseOffers": [
    {
      "productType": "travel-insurance",
      "offerId": "2b7e6ccb-67cd-49e6-880f-3d861c853945",
      "productCode": "SG_AXA_SCOOT_COMP",
      "unitPrice": 51.21,
      "currency": "SGD",
      "quantity": 1,
      "totalPrice": 51.21,
      "isSendEmail": true
    }
  ],
  "insureds": [
    {
      "id": "1",
      "firstName": "John",  // REQUIRED
      "lastName": "Doe",  // REQUIRED
      "email": "john@example.com"  // REQUIRED
    }
  ],
  "mainContact": {
    "id": "1",  // Must match an insured id
    "firstName": "John",  // REQUIRED
    "lastName": "Doe",  // REQUIRED
    "email": "john@example.com"  // REQUIRED
  }
}
```

**Minimal Required Fields (tested & working):**
- `id`, `firstName`, `lastName`, `email` (4 fields per traveler)
- All other fields are optional

---

## 💾 Database JSON Storage

### Quote Record (`quotes` table)

**Fields:**
- `ancileo_quotation_json` (JSONB) - Full quotation request sent to Ancileo
- `ancileo_purchase_json` (JSONB) - Full purchase request sent to Ancileo

**Structure matches Ancileo API structures above.**

### Trip Record (`trips` table)

**Fields:**
- `metadata_json` (JSONB) - Trip metadata including document references

```json
{
  "document_references": [
    {
      "document_type": "flight_confirmation",
      "filename": "Itinerary.pdf",
      "extracted_at": "2025-11-01T08:55:59Z"
    }
  ],
  "trip_type": "RT",
  "source": "document_upload"
}
```

---

## 🔌 Frontend-Backend API Structures

### Chat Message Response

**Endpoint:** `POST /api/v1/chat/message`  
**Response:**

```json
{
  "message": "Great! Here are your travel insurance options...",
  "trip_details": {
    "destination": "South Korea",
    "departure_date": "2025-12-28",
    "return_date": "2026-01-08",
    "departure_country": "SG",
    "arrival_country": "KR",
    "adults_count": 1,
    "children_count": 0
  },
  "travelers_data": {
    "ages": [21],
    "count": 1
  },
  "preferences": {
    "adventure_sports": false
  },
  "quote_data": {
    "success": true,
    "quotes": {
      "standard": { ... },
      "elite": { ... },
      "premier": { ... }
    }
  },
  "extracted_data": {
    "destination": "South Korea",
    "departure_date": "2025-12-28",
    "return_date": "2026-01-08",
    "travelers": ["Xianyan Winston Yang"]
  }
}
```

### Document Upload Response

**Endpoint:** `POST /api/v1/chat/upload-image`  
**Response:**

```json
{
  "message": "I've extracted the following information from your document...",
  "extracted_data": {
    "destination": "South Korea",
    "departure_date": "2025-12-28",
    "return_date": "2026-01-08",
    "travelers": ["Xianyan Winston Yang"],
    "duration": 11
  },
  "document_id": "550e8400-e29b-41d4-a716-446655440000",
  "session_id": "7e731f34-e464-4fb8-993c-984352fb378f"
}
```

---

## 🔑 Key Field Requirements Summary

### For Conversation Flow to Proceed to Pricing

All of these must be present in `state["trip_details"]`:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `destination` | string | ✅ Yes | Full country name (e.g., "South Korea") |
| `departure_date` | date/string | ✅ Yes | YYYY-MM-DD format |
| `return_date` | date/string | ✅ Yes | YYYY-MM-DD format (for RT trips) |
| `arrival_country` | string | ✅ Yes | ISO 2-letter code (e.g., "KR") |
| `adults_count` | integer | ✅ Yes | Must be >= 1 |

### For Ancileo Quotation API

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `context.tripType` | string | ✅ Yes | "RT" or "ST" |
| `context.departureDate` | string | ✅ Yes | YYYY-MM-DD |
| `context.departureCountry` | string | ✅ Yes | ISO 2-letter (e.g., "SG") |
| `context.arrivalCountry` | string | ✅ Yes | ISO 2-letter (e.g., "KR") |
| `context.adultsCount` | integer | ✅ Yes | >= 1 |
| `context.returnDate` | string | ⚠️ Conditional | Required for RT, omit for ST |

---

## 📝 Important Notes

1. **Date Formats:**
   - Always use `YYYY-MM-DD` format for strings
   - International dates (`datetime.date` objects) are also accepted
   - Use `parse_date_safe()` for parsing

2. **Country Codes:**
   - Full names in `destination` field (e.g., "South Korea")
   - ISO 2-letter codes in `arrival_country` and `departure_country` (e.g., "KR", "SG")
   - Use `GeoMapper.get_country_iso_code()` to convert

3. **Trip Type Detection:**
   - If `return_date` exists → `tripType: "RT"`
   - If `return_date` missing → `tripType: "ST"`

4. **Traveler Ages:**
   - Store as array: `[21, 8]` (ages)
   - Calculate `adults_count` = count of ages >= 18
   - Calculate `children_count` = count of ages < 18
   - Ensure at least 1 adult (if all children, add 1 adult)

5. **State Persistence:**
   - Always use direct references: `trip = state["trip_details"]` (not `.get()`)
   - Ensure state dicts exist before accessing: `if "trip_details" not in state: state["trip_details"] = {}`

---

## 🔗 Related Documentation

- **Ancileo API Details:** `ANCILEO_API_JSON_STRUCTURES.md`
- **Document Storage:** `JSON_STORAGE_STRUCTURES.md`
- **Document Extraction:** `DOCUMENT_JSON_STRUCTURES.md`

---

**Last Updated:** 2025-11-01  
**Maintained by:** Development Team  
**Purpose:** Single source of truth for all JSON structures in the system

